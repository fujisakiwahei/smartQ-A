# AIロジック詳細定義書

## 1. モデル構成
- エンジン: Gemini 3.0 Flash
- 分類タスク: 応答速度を最優先する設定（thinking_level: minimal）
- 生成タスク: 論理的な整合性と正確性を優先する設定（thinking_level: low）

## 2. 処理フロー詳細

### ステップ1：意図解析とカテゴリ特定（AI実行 ①）
ユーザーの質問内容を解析し、どの知識グループ（カテゴリ）を参照すべきか決定します。
- **入力情報**: ユーザーの質問 ＋ 利用企業が定義した全カテゴリ名 ＋ 各カテゴリの説明文。
- **内部処理**: 
    1. Geminiに対し、質問を提示されたカテゴリのいずれかに分類するよう指示。
    2. カテゴリの説明文（最大350文字）を参照し、文脈から最適なカテゴリを選択。
    3. 分類結果をデータとして抽出し、次のステップへ渡す。
- **例外処理**: どのカテゴリにも該当しない場合は、事前に定義された「汎用FAQ」または「その他」として処理。

### ステップ2：コンテキスト（知識）の動的抽出
特定されたカテゴリに関連するQ&Aデータのみをデータベースから取得し、AIが読み取れる形式に整形します。
- **内部処理**: 
    1. ステップ1で判定されたカテゴリに紐づく「質問と回答のペア」をデータベースから検索。
    2. 取得した複数のQ&Aデータを、一つの参照用ドキュメント（コンテキスト）としてテキスト結合。
- **整形ルール**: AIが「問い」と「答え」の境界を正しく認識できるよう、JSON形式に変換。

### ステップ3：根拠に基づいた回答生成（AI実行 ②）
抽出された知識（コンテキスト）のみを唯一の正解ソースとして、回答を構成します。
- **入力情報**: 整形された知識データ ＋ ユーザーの質問。
- **内部処理**: 
    1. **厳格な制約の適用**: AIに対し「提供された知識の中に回答の根拠がない場合は、絶対に自分の知識で補わず、分からないと答えること」を強く指示。
    2. **文脈の整理**: 知識データに基づき、ユーザーの質問に対する直接的な回答を、自然な会話形式で生成。
- **出力ルール**: 専門用語を避け、簡潔かつ企業のトーンに合わせた口調でテキストを出力。

### ステップ4：対話ログの記録と資産化
一連のやり取りを記録し、後の分析や改善に役立てます。
- **内部処理**: 
    1. ユーザーの原文、AIが判定したカテゴリ、最終的な回答をセットにして保存。
    2. 処理にかかった時間や利用されたリソース量を記録。
- **活用目的**: 「どのカテゴリの質問が多いか」「AIが答えられなかった質問は何か」を可視化するためのデータソースとする。

## 3. 運用上の品質指標
- **回答の安全性**: 知識ベース外の質問に対し、推測で答える「ハルシネーション」を物理的にゼロに近づける。
- **体感速度**: 分類と生成の2段階処理を行いつつも、Gemini 3.0 Flash の高速性を活かし、ユーザーを待たせない応答時間を維持する。
